#!/bin/bash

if [ $(update-alternatives --query glx|grep -i best|grep -i nvidia -c) -ne 0 ];then
    echo "loading nvidia preferences"
    export __GL_THREADED_OPTIMIZATIONS=0
    export __GL_YIELD="NOTHING"
    export __GL_MaxFramesAllowed=1
    nvidia-settings -a "[gpu:0]/GPUPowerMizerMode=1" >/dev/null 2>&1&
    nvidia-settings -a OpenGLImageSettings=3 >/dev/null 2>&1&
    nvidia-settings -a SyncToVBlank=0 >/dev/null 2>&1&
    nvidia-settings -a AllowFlipping=1 >/dev/null 2>&1&
    wait
else
    export mesa_glthread=false
    export vblank_mode=0 #no vsync
fi

# Execute the .desktop and .sh files in ~/.config/autostart
if [ -d  "$HOME/.config/autostart/" ]; then
  for file in $HOME/.config/autostart/*; do
    # .desktop files
    if [[ $file ==  *.desktop ]]; then
      dex "$file"
    fi
    # .sh files
    if [[ $file == *.sh ]]; then
      bash "$file"
    fi
  done
fi

cmst -m&
xterm&

exec startfluxbox
